@implements IDisposable
@if (!HideWidget || editModeService.EditMode)
{
    <div class="card mt-1 mb-3">
        @if (!HideHeader || editModeService.EditMode)
        {
            <div class="card-header hover-container">
                @(Widget.Title)
                <div class="float-end hover-effect fs-6">
                    @* <a href="" class="ms-1" title="Reload widget content" @onclick="@ReloadWidgetContent" @onclick:preventDefault>
                        <i class="bi bi-arrow-clockwise"></i>
                    </a> *@
                    @if (editModeService.EditMode)
                    {
                        <a href="" class="ms-1 drag-handle" title="Change widget location">
                            <i class="bi bi-arrows-move"></i>
                        </a>
                    }
                    <a title="@(Collapsed ? "Expand widget" : "Collapse widget")"
                       href="" class="ms-1"
                       @onclick="@ExpandCollapseWidget" @onclick:preventDefault>
                        <i class="bi @(Collapsed ? "bi-caret-right-fill" : "bi-caret-down-fill")"></i>
                    </a>
                    @if (editModeService.EditMode)
                    {
                        <a href="" class="ms-1" title="Copy Widget" @onclick="@CopyWidget" @onclick:preventDefault>
                            <i class="bi bi-copy"></i>
                        </a>
                        <a href="" class="ms-1" title="Edit widget configuration" @onclick="@EditWidgetConfiguration" @onclick:preventDefault>
                            <i class="bi bi-gear-fill"></i>
                        </a>
                        <a href="" class="ms-1" title="Remove widget" @onclick="@RemoveWidget" @onclick:preventDefault>
                            <i class="bi bi-trash3-fill"></i>
                        </a>
                    }
                </div>
            </div>
        }
        @if (widgetParameters != null && !Collapsed && widgetType != null)
        {
            <div class="card-body">
                <CascadingValue Value="@this">
                    <DynamicComponent Type="@widgetType.DisplayComponent" Parameters="widgetParameters" />
                </CascadingValue>
            </div>
        }
    </div>
}

@if (editModeService.EditMode)
{
    <BdfWidgetConfigForm WidgetInstance="@Widget" 
                         @ref="@bdfWidgetConfigForm" 
                         WidgetInstanceChanged="OnWidgetInstanceChanged" />
}

@code {
    [Parameter, EditorRequired] public WidgetInstance Widget { get; set; } = default!;
    [Parameter] public EventCallback<WidgetInstance> WidgetChanged { get; set; }
    [Parameter] public EventCallback<WidgetInstance> OnDeleteWidget { get; set; }
    [Parameter] public EventCallback<WidgetInstance> OnCopyWidget { get; set; }

    [Inject] public EditModeService editModeService { get; set; } = default!;
    [Inject] public WidgetTypeService widgetTypeService { get; set; } = default!;

    private Dictionary<string, object>? widgetParameters;
    private BdfWidgetConfigForm? bdfWidgetConfigForm;
    private WidgetType? widgetType;


    protected override void OnInitialized()
    {
        editModeService.EditModeChanged += OnEditModeChanged;
        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        if (widgetType == null)
        {
            widgetType = widgetTypeService.GetWidgetType(Widget.Type);
            if (widgetType != null)
            {
                HideHeader = widgetType.HideHeader;
                Collapsed = widgetType.Collapsed;
                HideWidget = widgetType.HideWidget;
            }
        }
        //if (widgetParameters == null)
            LoadWidgetParameters();
        base.OnParametersSet();
    }

    private void OnWidgetInstanceChanged(WidgetInstance widgetInstance)
    {
        Widget = widgetInstance;
        LoadWidgetParameters();
    }

    private void LoadWidgetParameters()
    {
        if (Widget == null || widgetType == null)
            return;
        widgetParameters = new Dictionary<string, object>();
        var config = widgetType.GetConfig(Widget?.Config);
        if (config != null)
            widgetParameters.Add("Config", config);
        
    }

    private bool hideWidget;
    public bool HideWidget
    {
        get => hideWidget;
        set 
        {
            if (hideWidget != value)
            {
                hideWidget = value;
                StateHasChanged();
            }
        }
    }

    private bool collapsed;
    public bool Collapsed
    {
        get => collapsed;
        set
        {
            if (collapsed != value)
            {
                collapsed = value;
                StateHasChanged();
            }
        }
    }

    private bool hideHeader;
    public bool HideHeader
    {
        get => hideHeader;
        set 
        {
            if (hideHeader != value)
            {
                hideHeader = value;
                StateHasChanged();
            }
        }
    }

    private async Task WidgetInstanceChanged(WidgetInstance widgetInstance)
    {
        await InvokeAsync(() => StateHasChanged());
    }


    private async void OnEditModeChanged(object? sender, EventArgs e)
    {
        await InvokeAsync(() => StateHasChanged());
    }

    private async Task ReloadWidgetContent()
    {
        try
        {
            await Task.Delay(0);
            throw new NotImplementedException();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"{nameof(ReloadWidgetContent)}: {ex}");
        }
    }

    public void ExpandCollapseWidget()
    {
        Collapsed = !Collapsed;
    }

    public async Task EditWidgetConfiguration()
    {
        if (bdfWidgetConfigForm != null)
            await bdfWidgetConfigForm.Open();
    }

    public async Task RemoveWidget()
    {
        try
        {
            await OnDeleteWidget.InvokeAsync(Widget);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"{nameof(RemoveWidget)}: {ex}");
        }
    }

    public async Task CopyWidget()
    {
        try
        {
            await OnCopyWidget.InvokeAsync(Widget);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"{nameof(RemoveWidget)}: {ex}");
        }
    }

    public void Dispose()
    {
        editModeService.EditModeChanged -= OnEditModeChanged;
    }
}
